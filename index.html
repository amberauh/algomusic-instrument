<body></body>
<script src="https://unpkg.com/tone"></script>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://algorithmicmusic.online/js/create-spectrum.js"></script>
<script src="https://algorithmicmusic.online/js/create-waveform.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<script>
let detector, video, synth;
let leftHandY = 0;
let lastChordIndex = -1;
let volumeSlider;
let updateloop;

// Chord options
const chords = [
  ['D2','F3','A3','C4','E4'],
  ['A2','G3','Bb3','C#4','F4'], 
  ['F2','E3','G3','A3','D4'], 
  ['C2','E3','G3','B3','D4'], 
  ['G2','F3','A3','B3','E4'], 
  ['D2','F3','A3','C4','E4']
];

const autoPanner = new Tone.AutoPanner("4n").toDestination().start();
  
//drum beat
const beat = "drumbeat2.wav";
const player = new Tone.Player({
  url: beat,
  loop: true,
  autostart: false,
})
player.toDestination()

let videoHeight = 0; // Will store video height dynamically
const chordHeightRange = 0.8; // Range for left hand chord selection

async function setupModel() {
  const model = poseDetection.SupportedModels.BlazePose;
  const detectorConfig = {
    runtime: 'mediapipe',
    solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/pose'
  };
  return await poseDetection.createDetector(model, detectorConfig);
}

function playChord(chordIndex) {
  synth.releaseAll(); // stop previous chord
  synth.triggerAttack(chords[chordIndex]); // play selected chord
  lastChordIndex = chordIndex;
}

// Detect "r" key press to retrigger the current chord
document.addEventListener("keydown", function (event) {
  if (event.key.toLowerCase() === "r" && lastChordIndex !== -1) {
    synth.releaseAll(); // stop previous chord
    synth.triggerAttack(chords[lastChordIndex]); // retrigger the same chord
  }
});

// stop all sounds when stop button is clicked
function stopAllSounds() {
  synth.releaseAll();
  lastChordIndex = -1; // reset last chord index
  cancelAnimationFrame(updateLoop);
}

async function update() {
  const poses = await detector.estimatePoses(video);
  const keypoints = poses[0]?.keypoints;

  if (keypoints) {
    leftHandY = keypoints[19]?.y || leftHandY;

    // calculate the maxY based on video height
    const minY = 0;
    const maxY = videoHeight * chordHeightRange;

    // select a chord based on the left hand Y position
    const chordIndex = Math.floor(nn.map(leftHandY, minY, maxY, 0, chords.length - 1));

    if (chordIndex >= 0 && chordIndex < chords.length && chordIndex !== lastChordIndex) {
      playChord(chordIndex);
    }
  }

  updateloop = requestAnimationFrame(update);
}

async function setup() {
  synth = new Tone.PolySynth().connect(autoPanner).toDestination();

  // Create the video element and start the camera feed
  video = nn.create('video')
    .addTo('body')
    .set({
      autoplay: true,
      muted: true,
      stream: await nn.askFor({ video: true })
    })
    .on('loadedmetadata', function() {
      videoHeight = video.clientHeight; // ensure video height is set correctly
    });

  video.css({ transform: 'scaleX(-1)' });

  detector = await setupModel();

  // Create a volume slider
  volumeSlider = nn.create('input')
    .set({ type: 'range', min: -30, max: 0, value: -10 })
    .css({ position: 'absolute', top: '10px', left: '10px', width: '150px' })
    .addTo('body')
    .on('input', function () {
      synth.volume.value = this.value; // Adjust synth volume
    });

  // Start button
  nn.create('button')
    .content('Play Instrument')
    .addTo('body')
    .on('click', () => {
      Tone.start(); 
      update();
    });

  // Stop button to release all sounds
  nn.create('button')
    .content('Stop Instrument')
    .addTo('body')
    .on('click', stopAllSounds);

  // Instruction text
  nn.create('p')
    .content('Press "R" to retrigger the current chord')
    .css({ position: 'absolute', top: '40px', left: '10px', color: 'white' })
    .addTo('body');
  
  //drum beat button
  nn.create('button')
    .content('Start Beat')
    .addTo('body')
    .on('click', () => player.start())
  
  nn.create('button')
    .content('Stop Beat')
    .addTo('body')
    .on('click', () => player.stop())
}

nn.on('load', setup);




</script>